<div id="contenedorForm">
  <h2>Realizar donaci√≥n</h2>

  <div class="info-banner">
    <h3>¬øPara qu√© usamos las donaciones?</h3>
    <p>Con tu donaci√≥n ayud√°s a cubrir:</p>
    <ul>
      <li>ü•£ Comida y alimentaci√≥n diaria</li>
      <li>üíä Pipetas, desparasitantes y medicaci√≥n</li>
      <li>üêæ Gastos veterinarios y urgencias</li>
      <li>üè† Mantenimiento del refugio</li>
    </ul>
  </div>

  <form [formGroup]="form" (ngSubmit)="onSubmit()">

    <!-- MONTO -->
    <div class="form-group" [class.invalid]="isInvalid('amount')">
      <label for="amount">Monto a donar ($)</label>
      <input
        type="number"
        id="amount"
        formControlName="amount"
        placeholder="Ej: 2000"
      />

      @if (getControl('amount')?.touched && getControl('amount')?.errors) {
        @if (hasError('amount', 'required')) {
          <small class="error">El monto es obligatorio.</small>
        }
        @if (hasError('amount', 'min')) {
          <small class="error">Debe ser mayor o igual a $100.</small>
        }
      }
    </div>

    <!-- M√âTODO DE PAGO -->
    <div class="form-group" [class.invalid]="isInvalid('method')">
      <label for="method">M√©todo de pago</label>
      <select id="method" formControlName="method">
        <option value="" disabled>Selecciona una opci√≥n</option>

        @for (m of methods; track $index) {
          <option [value]="m">{{ m }}</option>
        }
      </select>

      @if (getControl('method')?.touched && getControl('method')?.invalid) {
        <small class="error">Eleg√≠ un m√©todo de pago.</small>
      }
    </div>

    <!-- TARJETA -->
    @if (isCardMethod()) {
      <fieldset class="section">
        <legend>Datos de la tarjeta</legend>

        <!-- N√öMERO -->
        <div class="form-group" [class.invalid]="isInvalid('cardNumber')">
          <label for="cardNumber">N√∫mero de tarjeta</label>
          <input
            id="cardNumber"
            type="text"
            formControlName="cardNumber"
            placeholder="XXXX-XXXX-XXXX-XXXX"
          />

          @if (getControl('cardNumber')?.touched && getControl('cardNumber')?.errors) {
            @if (hasError('cardNumber', 'required')) {
              <small class="error">El n√∫mero de tarjeta es obligatorio.</small>
            }
            @if (hasError('cardNumber', 'pattern')) {
              <small class="error">Ingres√° un n√∫mero de tarjeta v√°lido.</small>
            }
           
          }
        </div>

        <!-- TITULAR -->
        <div class="form-group" [class.invalid]="isInvalid('cardHolder')">
          <label for="cardHolder">Titular</label>
          <input
            id="cardHolder"
            type="text"
            formControlName="cardHolder"
            placeholder="Nombre y apellido"
          />

          @if (getControl('cardHolder')?.touched && getControl('cardHolder')?.errors) {
            @if (hasError('cardHolder', 'required')) {
              <small class="error">El nombre del titular es obligatorio.</small>
            }@else if (hasError('cardHolder', 'minlength')) {
                <small class="error">Ingres√° un nombre v√°lido.</small>
              } @else {
                  <small class="error">El titular solo puede contener letras.</small>
                }
            }
        </div>

        <!-- FILA EXP + CVV -->
        <div class="form-row">

          <!-- VENCIMIENTO -->
          <div class="form-group" [class.invalid]="isInvalid('expiration')">
            <label for="expiration">Vencimiento</label>
            <input
              id="expiration"
              type="text"
              formControlName="expiration"
              placeholder="MM/AA"
            />

            @if (getControl('expiration')?.touched && getControl('expiration')?.errors) {
              @if (hasError('expiration', 'required')) {
                <small class="error">La fecha de vencimiento es obligatoria.</small>
              }
              @if (hasError('expiration', 'pattern')) {
                <small class="error">Us√° el formato MM/AA, una fecha valida.</small>
              }
            }
          </div>

          <!-- CVV -->
          <div class="form-group" [class.invalid]="isInvalid('cvv')">
            <label for="cvv">CVV</label>
            <input
              id="cvv"
              type="password"
              maxlength="3"
              formControlName="cvv"
              placeholder="***"
            />

            @if (getControl('cvv')?.touched && getControl('cvv')?.errors) {
              @if (hasError('cvv', 'required')) {
                <small class="error">El CVV es obligatorio.</small>
              } @else {
                <small class="error">El CVV debe tener 3 d√≠gitos num√©ricos.</small>
              }
              
              
            }
          </div>

        </div>
      </fieldset>
    }

    <!-- TRANSFERENCIA -->
    @if (isTransferMethod()) {
      <fieldset class="section">
        <legend>Datos para transferencia</legend>

        <p>Realiz√° tu transferencia utilizando los siguientes datos del refugio:</p>

        <div class="transfer-info-box">
          <p><strong>Alias:</strong> animales.peludos.refugio</p>
          <p><strong>CBU:</strong> 0000003100045678912345</p>
        </div>

        <p>Una vez realizada la transferencia, no olvides guardar el comprobante.</p>

        <!-- COMPROBANTE -->
        <div class="image-section">
          <label>Comprobante de transferencia</label>

          <div
            class="drop-zone"
            [class.hovering]="isHovering"
            (click)="fileInput.click()"
            (dragover)="onDragOver($event)"
            (dragleave)="onDragLeave($event)"
            (drop)="onDrop($event)"
          >
            <input
              type="file"
              #fileInput
              (change)="onFileSelected($event)"
              style="display: none"
              accept="image/*"
            />

            @if (!comprobantePreview) {
              <div class="drop-text">
                <p>Arrastr√° el comprobante aqu√≠ o hac√© clic para subir</p>
                <small>JPG, PNG (hasta 5MB)</small>
              </div>
            } @else {
              <div class="preview-container">
                <img
                  [src]="comprobantePreview"
                  alt="Vista previa comprobante"
                  class="preview-img"
                />

                <button
                  type="button"
                  (click)="clearComprobante(); $event.stopPropagation()"
                  class="btn-remove"
                >
                  Cambiar comprobante
                </button>
              </div>
            }
          </div>

          <input type="hidden" formControlName="comprobanteUrl" />
          <div class="error-space"></div>
        </div>

      </fieldset>
    }

    <!-- MENSAJE -->
    <div class="form-group" [class.invalid]="isInvalid('message')">
      <label for="message">Mensaje (opcional)</label>
      <textarea
        id="message"
        rows="3"
        formControlName="message"
        placeholder="Escrib√≠ un mensaje para el refugio..."
      ></textarea>

      @if (hasError('message', 'maxlength')) {
        <small class="error">M√°ximo 200 caracteres.</small>
      }
    </div>

    <!-- RESUMEN DE VALIDACI√ìN GENERAL -->
    @if (form.invalid && form.touched) {
      <p class="form-error-summary">
        Revis√° los campos marcados en rojo antes de continuar.
      </p>
    }

    <!-- BOT√ìN -->
    <button
      type="submit"
      [disabled]="form.invalid || isUploading || (isTransferMethod() && !file)"
    >
      {{ isUploading ? 'Subiendo comprobante...' : 'Confirmar donaci√≥n' }}
    </button>

  </form>

  <!-- RESUMEN -->
  @if (form.valid) {
    <section class="preview-card">
      <h3>Resumen de tu donaci√≥n</h3>

      <p>
        Vas a donar 
        <strong>
          {{ getControl('amount')?.value | currency:'ARS':'symbol':'1.0-0' }}
        </strong>
        mediante 
        <strong>
          {{ getControl('method')?.value | titlecase }}
        </strong>.
      </p>

      @if (isCardMethod()) {
        <p>
          La donaci√≥n se procesar√° con la tarjeta 
          <strong>
            {{ (getControl('cardNumber')?.value || '').slice(-4) }}
          </strong>.
        </p>

        @if (getControl('cardHolder')?.value) {
          <p>
            Titular:
            <strong>{{ getControl('cardHolder')?.value | titlecase }}</strong>
          </p>
        }
      }

      @if (getControl('message')?.value) {
        <p>
          Tu mensaje:
          <em>"{{ getControl('message')?.value }}"</em>
        </p>
      }
    </section>
  }
</div>
